  <!DOCTYPE html>
  <html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Sorteio de Times</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#00e676">
    <style>
      * { box-sizing: border-box; margin: 0; padding: 0; }

      body {
        font-family: Arial, sans-serif;
        background: #0b1020;
        color: #f5f5f5;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        padding: 10px;
      }

      .container {
        background: #161b30;
        width: 100%;
        max-width: 900px;
        border-radius: 10px;
        padding: 16px;
        box-shadow: 0 0 20px rgba(0,0,0,0.5);
      }

      h1 {
        text-align: center;
        margin-bottom: 12px;
        color: #00e676;
        font-size: 1.4rem;
      }

      .row {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 12px;
      }

      .col {
        flex: 1;
        min-width: 100%;
      }

      label {
        display: block;
        margin-bottom: 4px;
        font-size: 0.85rem;
        color: #cfd8dc;
      }

      select, input, textarea, button {
        width: 100%;
        padding: 8px 10px;
        border-radius: 5px;
        border: 1px solid #263238;
        background: #ffffff;
        color: #263238;
        font-size: 0.9rem;
      }

      textarea {
        min-height: 110px;
        resize: vertical;
      }

      .paste-wrapper {
        position: relative;
      }

      .paste-btn {
        position: absolute;
        right: 8px;
        bottom: 8px;
        padding: 6px 10px;
        min-width: unset;
        width: auto;
        background: #00e676;
        color: #000;
        border: none;
        border-radius: 8px;
        font-size: 0.8rem;
        box-shadow: 0 2px 6px #0006;
        opacity: 0.9;
        transition: all 0.15s;
      }

      .paste-btn:hover {
        opacity: 1;
        box-shadow: 0 3px 10px #0007;
      }

      button {
        cursor: pointer;
        background: #00e676;
        color: #000;
        font-weight: bold;
        border: none;
        transition: background 0.2s;
      }

      button:hover {
        background: #00c853;
      }

      .btn-secondary {
        background: #2979ff;
        color: #fff;
      }

      .btn-secondary:hover {
        background: #1565c0;
      }

      .btn-outline {
        background: transparent;
        border: 1px solid #00e676;
        color: #00e676;
      }

      .btn-outline:hover {
        background: rgba(0,230,118,0.1);
      }

      .btn-group {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .btn-group button {
        flex: 1;
        min-width: 120px;
      }

      .btn-icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
      }

      .mode-toggle {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
        margin-bottom: 6px;
      }

      .btn-toggle {
        min-width: 120px;
        padding: 6px 10px;
        border-radius: 6px;
        border: 1px solid #263238;
        background: #1c2331;
        color: #cfd8dc;
        cursor: pointer;
        transition: all 0.15s;
      }

      .btn-toggle.active {
        border-color: #00e676;
        color: #e4fff2;
        box-shadow: 0 0 0 1px rgba(0,230,118,0.15);
      }

      .textarea-ghost {
        background: #12182c;
        border: 1px dashed #263238;
        color: #eceff1;
      }

      .hidden {
        display: none !important;
      }

      .modal-overlay {
        position: fixed;
        inset: 0;
        background: radial-gradient(circle at 20% 20%, #00e67622, transparent 40%), rgba(3,6,20,0.75);
        backdrop-filter: blur(4px);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 14px;
        z-index: 9998;
      }

      .modal-box {
        background: linear-gradient(145deg, #0f1528 0%, #0b1020 45%, #0f1528 100%);
        border: 1px solid #1f2a3d;
        border-radius: 14px;
        box-shadow: 0 12px 40px #000a;
        max-width: 560px;
        width: 100%;
        padding: 18px;
        color: #e6f1f5;
        position: relative;
        overflow: hidden;
      }

      .modal-box::after {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(120deg, transparent 0%, rgba(0,230,118,0.06) 40%, transparent 80%);
        pointer-events: none;
      }

      .modal-head {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 12px;
      }

      .modal-chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: rgba(0,230,118,0.12);
        color: #00e676;
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 0.8rem;
        border: 1px solid rgba(0,230,118,0.35);
      }

      .modal-box h2 {
        margin: 0;
        color: #ffffff;
        font-size: 1.2rem;
        letter-spacing: 0.2px;
      }

      .modal-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
        gap: 10px;
        margin-top: 6px;
      }

      .card-tip {
        background: #131a2c;
        border: 1px solid #1f2a3d;
        border-radius: 10px;
        padding: 10px;
        display: grid;
        grid-template-columns: 28px 1fr;
        gap: 10px;
        align-items: start;
        color: #cfd8dc;
      }

      .card-tip i {
        color: #00e676;
      }

      .card-tip strong {
        color: #fff;
        display: block;
        margin-bottom: 2px;
      }

      .modal-actions {
        margin-top: 14px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: flex-end;
      }

      .manual-inline {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        align-items: center;
      }

      .manual-inline input {
        flex: 2;
        min-width: 180px;
      }

      .manual-inline select {
        flex: 1;
        min-width: 120px;
      }

      .manual-stack {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .btn-group.compact button {
        min-width: 140px;
        flex: 1;
      }

      .avoid-box {
        margin-top: 8px;
        padding: 10px 12px;
        border: 1px dashed #263238;
        border-radius: 10px;
        background: #0f1528;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .avoid-row {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .avoid-row select {
        min-width: 180px;
        flex: 1;
      }

      .pair-list {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
      }

      .pair-chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: #1b2336;
        border: 1px solid #263238;
        padding: 6px 10px;
        border-radius: 12px;
        font-size: 0.85rem;
      }

      .pair-chip button {
        width: auto;
        padding: 4px 8px;
        min-width: unset;
        background: transparent;
        color: #ff867c;
        border: 1px solid #ff867c55;
      }

      .name-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        padding: 6px 0;
      }

      .name-chip {
        background: #1b2336;
        color: #e6f1f5;
        padding: 6px 10px;
        border-radius: 12px;
        border: 1px solid #263238;
        cursor: pointer;
        font-size: 0.88rem;
        transition: all 0.15s;
      }

      .name-chip:hover {
        border-color: #00e67655;
        color: #fff;
      }

      .name-chip.selected {
        background: rgba(0,230,118,0.1);
        border-color: #00e67688;
        color: #00e676;
        box-shadow: 0 0 0 1px rgba(0,230,118,0.12);
      }

      .hint {
        margin-top: 6px;
        font-size: 0.82rem;
        color: #90a4ae;
      }

      .times-container {
        margin-top: 16px;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }

      .time-card {
        background: #1e2438;
        border-radius: 8px;
        padding: 10px 12px;
        min-width: 160px;
        flex: 1;
      }

      .time-card h3 {
        margin-bottom: 6px;
        color: #ffca28;
        font-size: 0.95rem;
      }

      .time-card ul {
        list-style: none;
        padding-left: 10px;
        font-size: 0.9rem;
      }

      .time-card li::before {
        content: "‚öΩ ";
        color: #64b5f6;
      }

      .time-card li.goleiro::before {
        content: "üß§ ";
        color: #ffca28;
      }

      .badge {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 20px;
        font-size: 0.75rem;
        background: #263238;
        color: #fff;
        margin-left: 5px;
      }

      .tag-gol {
        display: inline-block;
        margin-left: 6px;
        padding: 2px 6px;
        border-radius: 12px;
        background: rgba(255, 202, 40, 0.15);
        color: #ffca28;
        font-size: 0.75rem;
        font-weight: bold;
        border: 1px solid rgba(255, 202, 40, 0.35);
      }

      .footer-info {
        margin-top: 12px;
        font-size: 0.75rem;
        color: #b0bec5;
        text-align: center;
      }

      #contadorSobras {
        margin-top: 4px;
        font-size: 0.85rem;
        color: #ff5252;
        font-weight: bold;
      }

      @media (min-width: 600px) {
        .col-half {
          min-width: calc(50% - 5px);
        }
        h1 {
          font-size: 1.6rem;
        }
        textarea {
          min-height: 130px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <button onclick="window.location.href='cronometroeplacar.html'" style="width:100%;margin-bottom:16px;padding:12px 0;font-size:1.1rem;background:#2979ff;color:#fff;border:none;border-radius:8px;box-shadow:0 2px 8px #0004;cursor:pointer;font-weight:bold;">Ir para Cron√¥metro e Placar</button>
      <div id="notificacao" style="display:none;position:fixed;top:24px;left:50%;transform:translateX(-50%);background:#222c44;color:#fff;padding:14px 28px;border-radius:8px;box-shadow:0 2px 16px #0008;font-size:1.05rem;z-index:9999;min-width:220px;text-align:center;transition:opacity 0.3s;opacity:0;"></div>
      <div id="modalOverlay" class="modal-overlay hidden">
        <div class="modal-box">
          <div class="modal-head">
            <div class="modal-chip"><i data-lucide="info"></i> Guia r√°pido</div>
            <h2>Bem-vindo ao sorteio</h2>
          </div>
          <div class="modal-grid">
            <div class="card-tip">
              <i data-lucide="clipboard-check"></i>
              <div>
                <strong>Passo a passo</strong>
                Cole a lista &rarr; Processar &rarr; Sortear &rarr; Copiar times.
              </div>
            </div>
            <div class="card-tip">
              <i data-lucide="tag"></i>
              <div>
                <strong>Cabe√ßalhos aceitos</strong>
                GOLEIRO/GOL e ATLETAS/ATLETA/LINHA/JOGADOR (varia√ß√µes).
              </div>
            </div>
            <div class="card-tip">
              <i data-lucide="list"></i>
              <div>
                <strong>Modelo pronto</strong>
                Clique em "Modelo de lista" para copiar o formato padr√£o.
              </div>
            </div>
            <div class="card-tip">
              <i data-lucide="rotate-ccw"></i>
              <div>
                <strong>Goleiro por time</strong>
                Se faltar goleiro, o app repete em rodizio para n√£o deixar time sem GOL.
              </div>
            </div>
          </div>
          <div class="modal-actions">
            <button id="modalModelo" class="btn-outline btn-icon"><i data-lucide="clipboard-list"></i><span>Copiar modelo</span></button>
            <button id="modalFechar">Fechar</button>
          </div>
        </div>
      </div>
      <h1 style="text-align:center;color:#00e676;margin-bottom:12px;font-size:1.7rem;">Sorteio de Times</h1>
      <div style="width:100%;display:flex;justify-content:center;margin-bottom:18px;">
        <img src="goleio1.png" alt="Logo Goleio" style="max-width:320px;width:100%;height:auto;border-radius:12px;box-shadow:0 2px 16px #0006;">
      </div>
      <div class="row">
        <div class="col col-half">
          <label for="modalidade">Modalidade</label>
          <select id="modalidade">
            <option value="futsal">FUTSAL</option>
            <option value="society">SOCYET</option>
            <option value="campo">CAMPO</option>
          </select>
        </div>
        <div class="col col-half">
          <label for="jogadoresPorTime">Jogadores por time</label>
          <input type="number" id="jogadoresPorTime" min="1" value="5" />
        </div>
      </div>
      <div class="row">
        <div class="col">
          <div class="mode-toggle">
            <span>Como quer adicionar?</span>
            <div class="btn-group" style="gap:6px;">
              <button id="btnModoLista" class="btn-toggle active" type="button">Colar lista</button>
              <button id="btnModoManual" class="btn-toggle" type="button">Adicionar manual</button>
            </div>
          </div>
        </div>
      </div>
      <div class="row" id="blocoLista">
        <div class="col">
          <label for="textoBruto">Texto completo da lista (cole a mensagem do grupo aqui)</label>
          <div class="paste-wrapper">
            <textarea id="textoBruto" placeholder="Cole aqui a mensagem com:
  GOLEIROS
  ATLETAS DE ALTO N√çVEL
  LISTA DE ESPERA
  "></textarea>
            <button type="button" id="btnColarLista" class="paste-btn">Colar</button>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col">
          <div class="btn-group">
            <button id="btnProcessar">Processar lista</button>
            <button id="btnModelo" class="btn-outline btn-icon">
              <i data-lucide="clipboard-list"></i><span>Modelo de lista</span>
            </button>
            <button id="btnLimpar" class="btn-secondary">Limpar</button>
          </div>
        </div>
      </div>
      <div class="row" id="blocoManual">
        <div class="col">
          <label for="manualNome">Adicionar manualmente</label>
          <div class="manual-stack">
            <input id="manualNome" type="text" placeholder="Nome do jogador" />
            <div class="btn-group compact">
              <button id="btnAddJogador" class="btn-outline btn-icon"><i data-lucide="user-plus"></i><span>Adicionar como Linha</span></button>
              <button id="btnAddGoleiro" class="btn-secondary btn-icon"><i data-lucide="shield"></i><span>Adicionar como GOL</span></button>
            </div>
          </div>
          <p id="contagemAtual" class="hint">Goleiros: 0 | Jogadores: 0</p>
          <div class="btn-group compact" style="margin-top:6px;">
            <button id="btnToggleSeparar" class="btn-outline">Separar craques</button>
            <button id="btnToggleCorrigir" class="btn-outline">Mover jogador de fun√ß√£o</button>
          </div>
        </div>
      </div>
      <div class="row hidden" id="rowSeparar">
        <div class="col">
          <div class="avoid-box" id="secSeparar">
            <label>Evitar que joguem juntos</label>
            <div id="nomesGrid" class="name-grid"></div>
            <div class="btn-group compact">
              <button id="btnCriarGrupo">Separar selecionados</button>
              <button id="btnLimparSelecao" class="btn-outline">Limpar sele√ß√£o</button>
            </div>
            <p class="hint">Toque nos nomes (m√≠n. 2) e clique em separar. √ìtimo para dividir craques.</p>
            <div id="listaPares" class="pair-list"></div>
          </div>
        </div>
      </div>
      <div class="row hidden" id="blocoCorrigir">
        <div class="col">
          <label for="corrigeNome">Corrigir jogador (mover entre goleiro/linha)</label>
          <div class="manual-stack">
            <select id="selectMoverNome"></select>
            <input id="corrigeNome" type="text" placeholder="Ou digite um nome manualmente" />
            <div class="btn-group compact">
              <button id="btnMoverGoleiro" class="btn-outline">Mover para GOL</button>
              <button id="btnMoverJogador" class="btn-outline">Mover para Linha</button>
            </div>
          </div>
          <p class="hint">Use quando adicionou no lugar errado.</p>
        </div>
      </div>
      <div class="row" id="blocoAcaoManual">
        <div class="col">
          <div class="btn-group">
            <button id="btnSortearManual">Sortear Times</button>
            <button id="btnCopiarManual" class="btn-outline btn-icon">
              <i data-lucide="clipboard"></i><span>Copiar times</span>
            </button>
          </div>
        </div>
      </div>
      <div class="row" id="blocoPreview">
        <div class="col">
          <label for="previewLista">Pr√©via dos nomes adicionados</label>
          <textarea id="previewLista" class="textarea-ghost" readonly rows="6" placeholder="Nenhum nome adicionado ainda."></textarea>
        </div>
      </div>
      <div id="resultado" class="times-container"></div>
      <p class="footer-info">
        O app que faz seu futebol ser mais facil.
      </p>
    </div>

    <!-- Lucide Icons CDN (opcional) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
          // Notifica√ß√£o visual personalizada
          function mostrarNotificacao(msg, tempo=3000) {
            const notif = document.getElementById('notificacao');
            notif.textContent = msg;
            notif.style.display = 'block';
            notif.style.opacity = '1';
            clearTimeout(mostrarNotificacao._timeout);
            mostrarNotificacao._timeout = setTimeout(() => {
              notif.style.opacity = '0';
              setTimeout(() => { notif.style.display = 'none'; }, 350);
            }, tempo);
          }
      // inicializa √≠cones Lucide [web:80][web:83]
      if (window.lucide) {
        document.addEventListener("DOMContentLoaded", () => {
          lucide.createIcons();
        });
      }

      const modalidadeSelect = document.getElementById("modalidade");
      const jogadoresPorTimeInput = document.getElementById("jogadoresPorTime");
      const textoBrutoTextarea = document.getElementById("textoBruto");
      const btnModoLista = document.getElementById("btnModoLista");
      const btnModoManual = document.getElementById("btnModoManual");
      const btnProcessar = document.getElementById("btnProcessar");
      const btnSortearManual = document.getElementById("btnSortearManual");
      const btnCopiarManual = document.getElementById("btnCopiarManual");
      const btnLimpar = document.getElementById("btnLimpar");
      const btnModelo = document.getElementById("btnModelo");
      const btnColarLista = document.getElementById("btnColarLista");
      const manualNomeInput = document.getElementById("manualNome");
      const btnAddGoleiro = document.getElementById("btnAddGoleiro");
      const btnAddJogador = document.getElementById("btnAddJogador");
      const corrigeNomeInput = document.getElementById("corrigeNome");
      const btnMoverGoleiro = document.getElementById("btnMoverGoleiro");
      const btnMoverJogador = document.getElementById("btnMoverJogador");
      const selectMoverNome = document.getElementById("selectMoverNome");
      const btnToggleSeparar = document.getElementById("btnToggleSeparar");
      const btnToggleCorrigir = document.getElementById("btnToggleCorrigir");
      const rowSeparar = document.getElementById("rowSeparar");
      const secSeparar = document.getElementById("secSeparar");
      const nomesGrid = document.getElementById("nomesGrid");
      const btnCriarGrupo = document.getElementById("btnCriarGrupo");
      const btnLimparSelecao = document.getElementById("btnLimparSelecao");
      const listaParesDiv = document.getElementById("listaPares");
      const resultadoDiv = document.getElementById("resultado");
      const contagemAtual = document.getElementById("contagemAtual");
      const previewLista = document.getElementById("previewLista");
      const blocoLista = document.getElementById("blocoLista");
      const blocoManual = document.getElementById("blocoManual");
      const blocoCorrigir = document.getElementById("blocoCorrigir");
      const blocoPreview = document.getElementById("blocoPreview");
      const modalOverlay = document.getElementById("modalOverlay");
      const modalFechar = document.getElementById("modalFechar");
      const modalModelo = document.getElementById("modalModelo");

      let goleirosProcessados = [];
      let jogadoresProcessados = [];
      let paresRestritos = [];
      let selecaoGrupo = new Set();
      let secaoSepararAberta = false;
      let secaoCorrigirAberta = false;
      let ultimoTextoCopiavel = "";
      let modoEntrada = "lista"; // lista | manual

      // cabe√ßalhos aceitos para cada grupo (flex√≠vel para varia√ß√µes usadas pelo pessoal)
      const CAB_GOLS = ["GOLEIRO", "GOLEIROS", "GOL", "GOLEIRA", "GOLEIRAO"];
      const CAB_JOGS = [
        "ATLETAS DE ALTO NIVEL",
        "ATLETAS",
        "ATLETA",
        "LINHA",
        "JOGADOR",
        "JOGADORES",
        "JOGADOR DE LINHA",
        "JOGADORES DE LINHA"
      ];
      const CAB_ESPERA = ["LISTA DE ESPERA", "ESPERA", "RESERVA", "SUPLENTE"];
      const CAB_SEPARAR = ["SEPARAR", "SEPARAR CRAQUES", "NAO JUNTAR", "EVITAR JUNTOS"];

      const MODELO_LISTA = `‚úÖ LISTA DOS CONFIRMADOS
  Dia XX/XX/XXXX

  ü•Ö GOLEIROS

  üß§-
  üß§-

  ATLETAS DE ALTO N√çVEL

  1Ô∏è‚É£-
  2Ô∏è‚É£-
  3Ô∏è‚É£-
  4Ô∏è‚É£-
  5Ô∏è‚É£-
  6Ô∏è‚É£-
  7Ô∏è‚É£-
  üé±-
  9Ô∏è‚É£-
  üîü-
  1Ô∏è‚É£1Ô∏è‚É£-
  1Ô∏è‚É£2Ô∏è‚É£-
  1Ô∏è‚É£3Ô∏è‚É£-
  1Ô∏è‚É£4Ô∏è‚É£-
  1Ô∏è‚É£5Ô∏è‚É£-

  LISTA DE ESPERA
  1.
  2.
  3.
  4.
  5.

  SEPARAR CRAQUES (opcional)
  Nome A, Nome B
  Nome C, Nome D`;

      modalidadeSelect.addEventListener("change", () => {
        const mod = modalidadeSelect.value;
        if (mod === "futsal") jogadoresPorTimeInput.value = 5;
        if (mod === "society") jogadoresPorTimeInput.value = 7;
        if (mod === "campo") jogadoresPorTimeInput.value = 11;
      });

      function embaralhar(array) {
        let currentIndex = array.length;
        while (currentIndex !== 0) {
          const randomIndex = Math.floor(Math.random() * currentIndex);
          currentIndex--;
          [array[currentIndex], array[randomIndex]] =
            [array[randomIndex], array[currentIndex]];
        }
        return array;
      }

      // limpeza mais agressiva para tirar emojis/n√∫meros e sobrar s√≥ o nome
      function limparLinha(linha) {
        return linha
          .replace(/^[^A-Za-z√Ä-√ø]+/g, "")          // remove s√≠mbolos/emoji no come√ßo
          .replace(/[0-9]+[¬∫¬∞]?\s*[-‚Äì.]?\s*/g, "") // remove 1-, 10-, 1¬∫-, etc.
          .replace(/[üé±ü•Öüß§‚úÖ]/g, "")              // remove emojis customizados
          .replace(/\b(gol(eiro)?s?|goleirao|goleira)\b/gi, "") // evita cabe√ßalhos grudados
          .replace(/\b(atletas?|atleta|linha|jogadores?|jogador de linha)\b/gi, "")
          .replace(/[‚Ä¢\-‚Äì]+/g, " ")                // bullets e tra√ßos
          .trim();
      }

      function normalizarCabecalho(texto) {
        return texto
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "") // tira acentos
          .toUpperCase();
      }

      function contemCabecalho(linhaNormalizada, listaChaves) {
        return listaChaves.some(chave => linhaNormalizada.includes(chave));
      }

      function normalizarNomeJogador(nome) {
        return nome.replace(/\s*\(GOL\)/i, "").trim().toLowerCase();
      }

      function getTodosNomes() {
        return [...goleirosProcessados, ...jogadoresProcessados];
      }

      function aplicarRestricoes(times, grupos) {
        const avisos = [];

        const temAlguemDoGrupo = (grupoNorm, time) =>
          time.some(p => grupoNorm.has(normalizarNomeJogador(p)));

        grupos.forEach(grupo => {
          const grupoNorm = new Set(grupo.map(normalizarNomeJogador));

          for (let t = 0; t < times.length; t++) {
            // encontra todos do grupo neste time
            const indices = [];
            for (let j = 0; j < times[t].length; j++) {
              if (grupoNorm.has(normalizarNomeJogador(times[t][j]))) {
                indices.push(j);
              }
            }
            if (indices.length <= 1) continue;

            // mantem o primeiro, tenta mover os demais
            for (let k = 1; k < indices.length; k++) {
              const idx = indices[k];
              const jogador = times[t][idx];
              let destino = -1;
              let menor = Infinity;

              for (let tt = 0; tt < times.length; tt++) {
                if (tt === t) continue;
                if (temAlguemDoGrupo(grupoNorm, times[tt])) continue;
                if (times[tt].length < menor) {
                  menor = times[tt].length;
                  destino = tt;
                }
              }

              if (destino === -1) {
                avisos.push(`${grupo.join(" / ")}: n√£o foi poss√≠vel separar totalmente.`);
              } else {
                times[t].splice(idx, 1);
                times[destino].push(jogador);
              }
            }
          }
        });

        return avisos;
      }

      function processarLista() {
        const texto = textoBrutoTextarea.value;
        if (!texto.trim()) {
          mostrarNotificacao('Cole a lista completa primeiro.');
          return;
        }

        const linhas = texto.split("\n"); // quebra em linhas [web:66][web:69][web:72]

        let secao = "none"; // none | goleiros | jogadores | espera | separar
        const goleiros = [];
        const jogadores = [];
        const gruposSeparar = [];

        for (let bruta of linhas) {
          let linha = bruta.trim();
          if (!linha) continue;

          const upper = normalizarCabecalho(linha);

          if (contemCabecalho(upper, CAB_ESPERA)) {
            secao = "espera";
            continue;
          }
          if (contemCabecalho(upper, CAB_JOGS)) {
            secao = "jogadores";
            continue;
          }
          if (contemCabecalho(upper, CAB_GOLS)) {
            secao = "goleiros";
            continue;
          }
          if (contemCabecalho(upper, CAB_SEPARAR)) {
            secao = "separar";
            continue;
          }

          if (secao === "espera") {
            continue;
          }
          if (secao === "separar") {
            const partes = linha.split(",").map(p => limparLinha(p)).filter(Boolean);
            if (partes.length >= 2) {
              gruposSeparar.push(partes);
            }
            continue;
          }

          const nomeLimpo = limparLinha(linha);
          // garante que tenha pelo menos uma letra (evita quadradinhos) [web:61][web:69]
          if (!/[A-Za-z√Ä-√ø]/.test(nomeLimpo)) continue;

          if (secao === "goleiros") {
            goleiros.push(nomeLimpo);
          } else if (secao === "jogadores") {
            jogadores.push(nomeLimpo);
          }
        }

        goleirosProcessados = goleiros;
        jogadoresProcessados = jogadores;
        paresRestritos = gruposSeparar;

        mostrarNotificacao(
          'Processado! Goleiros: ' +
          goleirosProcessados.length +
          ' Jogadores: ' +
          jogadoresProcessados.length
        );
        atualizarContagem();
        atualizarPreviewLista();
        atualizarSelectPares();
        renderizarPares();
      }

      function sortearTimes() {
        const goleiros = [...goleirosProcessados];
        let jogadores = [...jogadoresProcessados];
        const porTime = parseInt(jogadoresPorTimeInput.value, 10);

        if (goleiros.length === 0 && jogadores.length === 0) {
          mostrarNotificacao("Nenhum jogador processado. Clique em 'Processar lista' primeiro.");
          return;
        }
        if (!porTime || porTime <= 0) {
          mostrarNotificacao('Informe a quantidade de jogadores por time.');
          return;
        }

        const totalJogadores = goleiros.length + jogadores.length;
        const numTimes = Math.ceil(totalJogadores / porTime);

        jogadores = embaralhar(jogadores);

        const times = [];
        for (let i = 0; i < numTimes; i++) {
          times.push([]);
        }

        // garante 1 goleiro por time (se faltarem, repete em rodizio)
        for (let t = 0; t < numTimes; t++) {
          if (goleiros.length === 0) break;
          const g = goleiros[t % goleiros.length];
          times[t].push(g + " (GOL)");
        }

        let iJog = 0;
        for (let t = 0; t < numTimes; t++) {
          while (times[t].length < porTime && iJog < jogadores.length) {
            times[t].push(jogadores[iJog]);
            iJog++;
          }
        }

        const avisosRestricao = aplicarRestricoes(times, paresRestritos);

        const tituloSorteio = "*GOLEIO* (Sorteio)";
        let texto = `${tituloSorteio}\n\n`;
        resultadoDiv.innerHTML = "";
        times.forEach((time, index) => {
          if (time.length === 0) return;

          const nomeTime = `Time ${index + 1}`;
          texto += `üèÜ **${nomeTime}** (${time.length} jogadores):\n`;
          const card = document.createElement("div");
          card.className = "time-card";

          const titulo = document.createElement("h3");
          titulo.innerHTML = `üèÜ <strong>${nomeTime}</strong>`;
          const badge = document.createElement("span");
          badge.className = "badge";
          badge.textContent = `üë• ${time.length} jogadores`;
          titulo.appendChild(badge);

          const lista = document.createElement("ul");
          time.forEach(j => {
            const isGoleiro = j.toUpperCase().includes("(GOL)");
            const nomeLimpo = j.replace(/\s*\(GOL\)/i, "").trim();
            const emoji = isGoleiro ? "üß§" : "‚öΩ";
            texto += ` - ${emoji} ${nomeLimpo}${isGoleiro ? " (GOL)" : ""}\n`;

            const li = document.createElement("li");
            if (isGoleiro) {
              li.classList.add("goleiro");
              const nomeSpan = document.createElement("span");
              nomeSpan.textContent = nomeLimpo;
              const tag = document.createElement("span");
              tag.className = "tag-gol";
              tag.textContent = "üß§ GOL";
              li.appendChild(nomeSpan);
              li.appendChild(tag);
            } else {
              li.textContent = nomeLimpo;
            }
            lista.appendChild(li);
          });
          texto += "\n";

          card.appendChild(titulo);
          card.appendChild(lista);
          resultadoDiv.appendChild(card);
        });

        if (avisosRestricao.length) {
          texto += "Avisos:\n" + avisosRestricao.map(a => ` - ${a}`).join("\n") + "\n";
          mostrarNotificacao('Sorteio feito. Alguns pares n√£o puderam ser separados.');
        } else {
          mostrarNotificacao('Sorteio conclu√≠do!');
        }

        ultimoTextoCopiavel = texto.trim();
      }

      function atualizarContagem() {
        contagemAtual.textContent =
          `Goleiros: ${goleirosProcessados.length} | Jogadores: ${jogadoresProcessados.length}`;
      }

      function atualizarPreviewLista() {
        if (goleirosProcessados.length === 0 && jogadoresProcessados.length === 0) {
          previewLista.value = "Nenhum nome adicionado ainda.";
          return;
        }
        const linhas = [];
        linhas.push("GOLEIROS:");
        if (goleirosProcessados.length === 0) {
          linhas.push("- (nenhum goleiro)");
        } else {
          goleirosProcessados.forEach(n => linhas.push(`- üß§ ${n}`));
        }
        linhas.push("");
        linhas.push("JOGADORES:");
        if (jogadoresProcessados.length === 0) {
          linhas.push("- (nenhum jogador de linha)");
        } else {
          jogadoresProcessados.forEach(n => linhas.push(`- ‚öΩ ${n}`));
        }
        previewLista.value = linhas.join("\n");
      }

      function atualizarSelectPares() {
        const nomes = getTodosNomes();
        const opts = nomes.map(n => `<option value="${n}">${n}</option>`).join("");
        selectMoverNome.innerHTML = `<option value="">Selecione um nome</option>` + opts;
        renderNomesGrid();
      }

      function renderizarPares() {
        if (paresRestritos.length === 0) {
          listaParesDiv.innerHTML = '<span class="hint">Nenhum grupo cadastrado.</span>';
          return;
        }
        listaParesDiv.innerHTML = "";
        paresRestritos.forEach((par, idx) => {
          const chip = document.createElement("div");
          chip.className = "pair-chip";
          chip.textContent = par.join("  ‚úï  ");
          const btn = document.createElement("button");
          btn.type = "button";
          btn.textContent = "remover";
          btn.addEventListener("click", () => {
            paresRestritos.splice(idx, 1);
            renderizarPares();
          });
          chip.appendChild(btn);
          listaParesDiv.appendChild(chip);
        });
      }

      function renderNomesGrid() {
        const nomes = getTodosNomes();
        const selected = new Set(selecaoGrupo);
        if (nomes.length === 0) {
          nomesGrid.innerHTML = '<span class="hint">Nenhum nome carregado.</span>';
          return;
        }
        nomesGrid.innerHTML = "";
        selecaoGrupo = new Set([...selecaoGrupo].filter(n => nomes.includes(n)));
        nomes.forEach(nome => {
          const chip = document.createElement("button");
          chip.type = "button";
          chip.className = "name-chip" + (selected.has(nome) ? " selected" : "");
          chip.textContent = nome;
          chip.addEventListener("click", () => toggleSelecaoNome(nome));
          nomesGrid.appendChild(chip);
        });
      }

      function toggleSelecaoNome(nome) {
        if (selecaoGrupo.has(nome)) {
          selecaoGrupo.delete(nome);
        } else {
          selecaoGrupo.add(nome);
        }
        renderNomesGrid();
      }

      function limparSelecaoGrupo() {
        selecaoGrupo.clear();
        renderNomesGrid();
      }

      function adicionarPar() {
        const grupo = [...selecaoGrupo];
        if (grupo.length < 2) {
          mostrarNotificacao('Selecione pelo menos 2 nomes.');
          return;
        }
        const grupoNorm = grupo.map(normalizarNomeJogador).sort().join("|");
        const existe = paresRestritos.some(g => g.map(normalizarNomeJogador).sort().join("|") === grupoNorm);
        if (existe) {
          mostrarNotificacao('Esse grupo j√° est√° na lista.');
          return;
        }
        paresRestritos.push(grupo);
        selecaoGrupo.clear();
        renderNomesGrid();
        renderizarPares();
        mostrarNotificacao('Grupo adicionado para separar.');
      }

      function alternarModo(modo) {
        modoEntrada = modo;
        btnModoLista.classList.toggle("active", modo === "lista");
        btnModoManual.classList.toggle("active", modo === "manual");
        const isManual = modo === "manual";
        textoBrutoTextarea.disabled = isManual;
        textoBrutoTextarea.placeholder = isManual
          ? "Modo manual ativo. Adicione nomes pelo formul√°rio abaixo."
          : "Cole aqui a mensagem com:\nGOLEIROS\nATLETAS DE ALTO N√çVEL\nLISTA DE ESPERA\n";
        blocoLista.classList.toggle("hidden", isManual);
        blocoManual.classList.toggle("hidden", !isManual);
        blocoPreview.classList.toggle("hidden", !isManual);
        btnProcessar.classList.toggle("hidden", isManual);
        btnModelo.classList.toggle("hidden", isManual);
        atualizarSelectPares();
        if (!secaoCorrigirAberta) blocoCorrigir.classList.add("hidden");
        if (!secaoSepararAberta) {
          secSeparar.classList.add("hidden");
          rowSeparar.classList.add("hidden");
        }
      }

      function adicionarManual(tipo) {
        const nome = manualNomeInput.value.trim();
        if (!nome) {
          mostrarNotificacao('Digite um nome para adicionar.');
          return;
        }

        if (tipo === "goleiro") {
          goleirosProcessados.push(nome);
        } else {
          jogadoresProcessados.push(nome);
        }

        manualNomeInput.value = "";
        atualizarContagem();
        atualizarPreviewLista();
        atualizarSelectPares();
        mostrarNotificacao(`${nome} adicionado como ${tipo === "goleiro" ? "goleiro" : "jogador"}.`);
      }

      function moverJogador(destino) {
        const nomeDigitado = corrigeNomeInput.value.trim();
        const nomeSelecionado = selectMoverNome.value;
        const nome = nomeDigitado || nomeSelecionado;
        if (!nome) {
          mostrarNotificacao('Informe ou selecione o nome para corrigir.');
          return;
        }

        const nomeLower = nome.toLowerCase();
        const idxGol = goleirosProcessados.findIndex(n => n.toLowerCase() === nomeLower);
        const idxJog = jogadoresProcessados.findIndex(n => n.toLowerCase() === nomeLower);

        if (idxGol === -1 && idxJog === -1) {
          mostrarNotificacao('Nome n√£o encontrado na lista atual.');
          return;
        }

        // Se j√° est√° no destino, apenas avisa
        if ((destino === "goleiro" && idxGol !== -1 && idxJog === -1) ||
            (destino === "jogador" && idxJog !== -1 && idxGol === -1)) {
          mostrarNotificacao('Esse nome j√° est√° no tipo escolhido.');
          return;
        }

        if (idxGol !== -1) goleirosProcessados.splice(idxGol, 1);
        if (idxJog !== -1) jogadoresProcessados.splice(idxJog, 1);

        if (destino === "goleiro") {
          goleirosProcessados.push(nome);
        } else {
          jogadoresProcessados.push(nome);
        }

        corrigeNomeInput.value = "";
        selectMoverNome.value = "";
        atualizarContagem();
        atualizarPreviewLista();
        atualizarSelectPares();
        mostrarNotificacao(`Movido para ${destino === "goleiro" ? "GOLEIRO" : "JOGADOR"}.`);
      }

      async function copiarTimes() {
        if (!ultimoTextoCopiavel) {
          mostrarNotificacao('Nenhum sorteio para copiar. Sorteie os times primeiro.');
          return;
        }
        try {
          await navigator.clipboard.writeText(ultimoTextoCopiavel); // Clipboard API [web:45][web:78]
          mostrarNotificacao('Times copiados para a √°rea de transfer√™ncia!');
        } catch (err) {
          console.error(err);
          mostrarNotificacao('N√£o foi poss√≠vel copiar os times. Verifique as permiss√µes do navegador.');
        }
      }

      async function copiarModeloLista() {
        try {
          await navigator.clipboard.writeText(MODELO_LISTA); // copia modelo [web:45][web:78]
          mostrarNotificacao('Modelo de lista copiado! Cole no grupo e preencha os nomes.');
        } catch (err) {
          console.error(err);
          mostrarNotificacao('N√£o foi poss√≠vel copiar o modelo. Verifique as permiss√µes do navegador.');
        }
      }

      btnProcessar.addEventListener("click", processarLista);
      btnSortearManual.addEventListener("click", sortearTimes);
      btnCopiarManual.addEventListener("click", copiarTimes);
      btnColarLista.addEventListener("click", async () => {
        try {
          const clip = await navigator.clipboard.readText();
          if (!clip) {
            mostrarNotificacao('√Årea de transfer√™ncia vazia.');
            return;
          }
          textoBrutoTextarea.value = clip;
          mostrarNotificacao('Lista colada da √°rea de transfer√™ncia.');
        } catch (err) {
          console.error(err);
          mostrarNotificacao('N√£o foi poss√≠vel colar. Verifique as permiss√µes do navegador.');
        }
      });
      btnModelo.addEventListener("click", copiarModeloLista);
      btnAddGoleiro.addEventListener("click", () => adicionarManual("goleiro"));
      btnAddJogador.addEventListener("click", () => adicionarManual("jogador"));
      btnMoverGoleiro.addEventListener("click", () => moverJogador("goleiro"));
      btnMoverJogador.addEventListener("click", () => moverJogador("jogador"));
      btnToggleSeparar.addEventListener("click", () => {
        secaoSepararAberta = !secaoSepararAberta;
        secSeparar.classList.toggle("hidden", !secaoSepararAberta);
        rowSeparar.classList.toggle("hidden", !secaoSepararAberta);
        btnToggleSeparar.textContent = secaoSepararAberta ? "Fechar separar craques" : "Separar craques";
      });
      btnToggleCorrigir.addEventListener("click", () => {
        secaoCorrigirAberta = !secaoCorrigirAberta;
        blocoCorrigir.classList.toggle("hidden", !secaoCorrigirAberta);
        btnToggleCorrigir.textContent = secaoCorrigirAberta ? "Fechar mover fun√ß√£o" : "Mover jogador de fun√ß√£o";
      });
      btnModoLista.addEventListener("click", () => alternarModo("lista"));
      btnModoManual.addEventListener("click", () => alternarModo("manual"));
      btnCriarGrupo.addEventListener("click", adicionarPar);
      btnLimparSelecao.addEventListener("click", limparSelecaoGrupo);
      modalFechar.addEventListener("click", () => {
        modalOverlay.classList.add("hidden");
      });
      modalOverlay.addEventListener("click", (e) => {
        if (e.target === modalOverlay) modalOverlay.classList.add("hidden");
      });
      modalModelo.addEventListener("click", () => {
        copiarModeloLista();
        modalOverlay.classList.add("hidden");
      });

      btnLimpar.addEventListener("click", () => {
        textoBrutoTextarea.value = "";
        resultadoDiv.innerHTML = "";
        goleirosProcessados = [];
        jogadoresProcessados = [];
        paresRestritos = [];
        selecaoGrupo.clear();
        secaoSepararAberta = false;
        secaoCorrigirAberta = false;
        ultimoTextoCopiavel = "";
        atualizarContagem();
        atualizarPreviewLista();
        atualizarSelectPares();
        renderizarPares();
        secSeparar.classList.add("hidden");
        rowSeparar.classList.add("hidden");
        blocoCorrigir.classList.add("hidden");
        btnToggleSeparar.textContent = "Separar craques";
        btnToggleCorrigir.textContent = "Mover jogador de fun√ß√£o";
      });

      atualizarContagem();
      atualizarPreviewLista();
      alternarModo("lista");
      atualizarSelectPares();
      renderizarPares();
      document.addEventListener("DOMContentLoaded", () => {
        modalOverlay.classList.remove("hidden");
      });
    </script>
    <script>
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("service-worker.js")
          .then(() => console.log("PWA registrado com sucesso"))
          .catch(err => console.error("Erro no PWA", err));
      }
    </script>
  </body>
  </html>
